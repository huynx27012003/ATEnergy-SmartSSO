/**
 * jQuery Table 1.0
 *
 * Author: Joe
 */

var smart = smart ? smart : {};
(function (sm, $) {
	sm.table = {
		// External configurable parameters
		options: {
			checkbox: { hide: false },
			index: { hide: true, title: "Index", align: "center" },

			url: "",
			formId: null,
			// Search/filter JSON parameters
			data: {},
			tools: [],
			columns: [],
			operate: [],
			pagination: { hide: false, size: 20, sizes: [10, 20, 50, 100] },
			after: function () {},
		},

		// Internal use
		settings: {
			// Current table object
			obj: {},

			// AJAX request data
			firstResult: 0,
			records: [],
			offsetSize: 0,
			pages: 0,
			current: 1,
			total: 0,
			size: 20,
		},

		toolsHandler: function () {
			// Default tool button behavior
			var def = { text: "", clazz: "", icon: "", show: function () { return true; }, handler: function () {} };
			$(sm.table.options.tools).each(function (i, d) {
				d = $.extend({}, def, d);
				var $t = $("#_tr" + i);
				if (d.show()) {
					$t.click(function () {
						d.handler();
					});
				} else {
					$t.hide();
				}
			});
		},

		createTools: function () {
			var tableId = sm.table.settings.obj.attr("id");
			var html = "";
			html += '<div class="row">';
			html += '	<div class="col-xs-12">';
			html += '		<div id="' + tableId + '_length" class="dataTables_length">';
			var button;
			var permission;
			for (var i = 0, len = sm.table.options.tools.length; i < len; i++) {
				button = sm.table.options.tools[i];
				permission = button.permission ? 'permission="' + button.permission + '"' : "";
				html +=
					'			<button  id="_tr' +
					i +
					'" class="btn btn-sm btn-white ' +
					button.clazz +
					' btn-bold" ' +
					permission +
					">";
				html += '				<i class="ace-icon ' + button.icon + ' bigger-120"></i>';
				html += "					" + button.text;
				html += "			</button>";
			}
			html += "		</div>";
			html += "	</div>";
			html += "</div>";
			sm.table.settings.obj.before(html);

			// Add event listeners for toolbar buttons
			sm.table.toolsHandler();
		},

		createHeader: function () {
			var thead = $("<thead/>").appendTo(sm.table.settings.obj);
			var row = $("<tr/>").appendTo(thead);
			var cell, column;

			// Add checkbox column
			if (!sm.table.options.checkbox.hide) {
				cell = $('<th/>')
					.html('<label class="pos-rel"><input type="checkbox" class="ace" /><span class="lbl"></span></label>')
					.addClass("center");
				cell.appendTo(row);
			}

			// Add index column
			if (!sm.table.options.index.hide) {
				cell = $("<th/>").html(sm.table.options.index.title);
				if (sm.table.options.index.align) {
					cell.addClass("text-" + sm.table.options.index.align);
				}
				cell.appendTo(row);
			}

			// Default column properties
			var def = { align: "center", mobileHide: false, hide: false };
			// Add dynamic columns
			for (var i = 0, len = sm.table.options.columns.length; i < len; i++) {
				column = (sm.table.options.columns[i] = $.extend({}, def, sm.table.options.columns[i]));
				if (column.hide) continue;
				cell = $("<th/>").html(column.title);
				if (column.align) cell.addClass("text-" + column.align);
				if (column.mobileHide) cell.addClass("hidden-480");
				cell.appendTo(row);
			}

			// Add operation column
			if (sm.table.options.operate.length > 0) {
				cell = $("<th/>");
				cell.appendTo(row);
			}
		},

		operationHandler: function (c, i) {
			// Default operation behavior
			var def = { text: "", clazz: "", icon: "", show: function () { return true; }, handler: function () {} };
			$(sm.table.options.operate).each(function (j, d) {
				d = $.extend({}, def, d);
				var $m = $("#_mr" + i + "c" + j);
				var $d = $("#_dr" + i + "c" + j);
				if (d.show(c, i)) {
					$m.click(function () {
						$("th input[type=checkbox], td input[type=checkbox]").prop("checked", false);
						$(this).closest("tr").find("td input[type=checkbox]").prop("checked", true);
						d.handler(c, i);
					});
					$d.click(function () {
						$("th input[type=checkbox], td input[type=checkbox]").prop("checked", false);
						$(this).closest("tr").find("td input[type=checkbox]").prop("checked", true);
						d.handler(c, i);
					});
				} else {
					$m.hide();
					$d.hide();
				}
			});
		},

		operation: function (cell, index) {
			var button;
			var html = "";
			var buttonm = "";
			buttonm += '<div class="hidden-sm hidden-xs action-buttons">';

			var md = "";
			md += '<div class="hidden-md hidden-lg">';
			md += '	<div class="inline pos-rel">';
			md +=
				'		<button class="btn btn-minier btn-yellow dropdown-toggle" data-toggle="dropdown" data-position="auto">';
			md += '			<i class="ace-icon fa fa-caret-down icon-only bigger-120"></i>';
			md += "		</button>";
			md +=
				'		<ul class="dropdown-menu dropdown-only-icon dropdown-yellow dropdown-menu-right dropdown-caret dropdown-close">';
			var permission;
			for (var i = 0, len = sm.table.options.operate.length; i < len; i++) {
				button = sm.table.options.operate[i];
				permission = button.permission ? 'permission="' + button.permission + '"' : "";
				buttonm +=
					'	<a id="_mr' +
					index +
					"c" +
					i +
					'" class="' +
					button.clazz +
					'" href="javascript:void(0)" title="' +
					button.text +
					'" ' +
					permission +
					">";
				buttonm += '		<i class="ace-icon ' + button.icon + ' bigger-110"></i>';
				buttonm += "	</a>";

				md += "			<li>";
				md +=
					'				<a id="_dr' +
					index +
					"c" +
					i +
					'" href="javascript:void(0)" title="' +
					button.text +
					'" class="tooltip-info" data-rel="tooltip" title="View" ' +
					permission +
					">";
				md += '					<span class="' + button.clazz + '">';
				md += '						<i class="ace-icon ' + button.icon + ' bigger-110"></i>';
				md += "					</span>";
				md += "				</a>";
				md += "			</li>";
			}
			buttonm += "</div>";

			md += "		</ul>";
			md += "	</div>";
			md += "</div>";
			html = buttonm + md;
			cell.html(html);
		},

		bodyHandler: function () {
			var tableId = sm.table.settings.obj.attr("id");

			// Initialize checkboxes
			$("th input[type=checkbox], td input[type=checkbox]").prop("checked", false);

			// Select all / deselect all
			$("#" + tableId + " > thead > tr > th input[type=checkbox]")
				.eq(0)
				.on("click", function () {
					var th_checked = this.checked;
					$(this)
						.closest("table")
						.find("tbody > tr > td input[type=checkbox]")
						.each(function () {
							this.checked = th_checked;
						});
				});
		},

		createBody: function () {
			var thead = $("<tbody/>").appendTo(sm.table.settings.obj);
			var cell, row, column, data;

			if (sm.table.settings.records.length > 0) {
				for (var i = 0, len = sm.table.settings.records.length; i < len; i++) {
					data = sm.table.settings.records[i];
					row = $("<tr/>").appendTo(thead);

					// Add checkbox
					if (!sm.table.options.checkbox.hide) {
						cell = $('<td/>')
							.html(
								'<label class="pos-rel"><input type="checkbox" class="ace" index="' +
								i +
								'"/><span class="lbl"></span></label>'
							)
							.addClass("center");
						cell.appendTo(row);
					}

					// Add index
					if (!sm.table.options.index.hide) {
						cell = $("<td/>").html(i + 1 + sm.table.settings.size * (sm.table.settings.current - 1));
						if (sm.table.options.index.align) cell.addClass("text-" + sm.table.options.index.align);
						cell.appendTo(row);
					}

					// Add dynamic columns
					for (var j = 0, length = sm.table.options.columns.length; j < length; j++) {
						column = sm.table.options.columns[j];
						if (column.hide) continue;
						if (column.replace) {
							cell = $("<td/>").html(column.replace(data, i, j));
						} else {
							cell = $("<td/>").html(data[column.field] == null ? "" : data[column.field] + "");
						}
						if (column.align) cell.addClass("text-" + column.align);
						if (column.clazz) cell.addClass(column.clazz);
						if (column.mobileHide) cell.addClass("hidden-480");
						cell.appendTo(row);
					}

					// Add operation column
					if (sm.table.options.operate.length > 0) {
						cell = $("<td/>");
						cell.appendTo(row);
						// Add operation buttons
						sm.table.operation(cell, i);
						// Bind event handlers
						sm.table.operationHandler(data, i);
					}
				}
			} else {
				row = $("<tr/>").appendTo(thead).addClass("odd");
				row.html(
					'<td valign="top" colspan="' +
					(sm.table.options.columns.length + 2) +
					'" class="dataTables_empty">No records yet</td>'
				);
			}

			// Add checkbox event handlers after body load
			sm.table.bodyHandler();
		},

		ajaxData: function () {
			var bool = false;
			if (sm.table.options.formId != null) {
				sm.table.options.data = $.extend({}, sm.table.options.data, $.formJson(sm.table.options.formId));
			}
			$.ajax({
				type: "get",
				url: sm.table.options.url,
				data: $.extend({}, sm.table.options.data, {
					current: sm.table.settings.current,
					size: sm.table.settings.size,
				}),
				async: false,
				cache: false,
				dataType: "json",
				success: function (d) {
					var data = d.data;
					if (data) {
						// Tree structure
						if (data.length != undefined) {
							sm.table.settings.records = data;
							sm.table.settings.total = data.length;
						} else {
							sm.table.settings = $.extend({}, sm.table.settings, data);
						}
					}
					bool = true;
				},
			});
			return bool;
		},

		paginationHandler: function () {
			var tableId = sm.table.settings.obj.attr("id");
			if (sm.table.settings.current > 1) {
				$("#" + tableId + "_first > a").click(function () {
					sm.table.settings.current = 1;
					sm.table.reload();
				});

				$("#" + tableId + "_previous > a").click(function () {
					sm.table.settings.current = sm.table.settings.current - 1;
					sm.table.reload();
				});
			}

			if (sm.table.settings.current < sm.table.settings.pages) {
				$("#" + tableId + "_next > a").click(function () {
					sm.table.settings.current = sm.table.settings.current + 1;
					sm.table.reload();
				});

				$("#" + tableId + "_last > a").click(function () {
					sm.table.settings.current = sm.table.settings.pages;
					sm.table.reload();
				});
			}

			$(".paginate_number_button").click(function () {
				sm.table.settings.current = $(this).find("a").html();
				sm.table.reload();
			});

			// Change page size
			$("#" + tableId + "_info > label > select").change(function () {
				sm.table.settings.current = 1;
				sm.table.settings.size = $(this).val();
				sm.table.reload();
			});
		},

		createPagination: function () {
			var tableId = sm.table.settings.obj.attr("id");
			var html = "";
			html += '<div class="row">';
			html += '	<div class="col-xs-6">';
			html +=
				'		<div id="' +
				tableId +
				'_info" class="dataTables_info" role="status" aria-live="polite">';
			html +=
				'			<label>Display per page: <select name="' +
				tableId +
				'_length" aria-controls="' +
				tableId +
				'" class="form-control input-sm">';
			var $size;
			for (var i = 0, len = sm.table.options.pagination.sizes.length; i < len; i++) {
				$size = sm.table.options.pagination.sizes[i];
				html +=
					'					<option	value="' +
					$size +
					'" ' +
					($size == sm.table.settings.size ? 'selected="selected"' : "") +
					" >" +
					$size +
					"</option>";
			}
			html +=
				'			</select> records, </label> <label>Total&nbsp;' +
				sm.table.settings.total +
				"&nbsp;records</label>";
			html += "		</div>";
			html += "	</div>";
			html += '	<div class="col-xs-6">';
			html +=
				'		<div id="' +
				tableId +
				'_paginate" class="dataTables_paginate paging_full_numbers">';
			html += '			<ul class="pagination">';
			html +=
				'				<li id="' +
				tableId +
				'_first" class="paginate_button first ' +
				(sm.table.settings.current > 1 ? "" : "disabled") +
				'" aria-controls="' +
				tableId +
				'" tabindex="0"><a href="javascript:void(0)">First</a></li>';
			html +=
				'				<li id="' +
				tableId +
				'_previous" class="paginate_button previous ' +
				(sm.table.settings.current > 1 ? "" : "disabled") +
				'" aria-controls="' +
				tableId +
				'" tabindex="0"><a href="javascript:void(0)">Previous</a></li>';

			var i = sm.table.settings.current - sm.table.settings.offsetSize < 1 ? 1 : sm.table.settings.current - sm.table.settings.offsetSize;
			for (; i < sm.table.settings.current; i++) {
				if (i > 0) {
					html +=
						'				<li class="paginate_button paginate_number_button" aria-controls="' +
						tableId +
						'" tabindex="0"><a href="javascript:void(0)">' +
						i +
						"</a></li>";
				}
			}

			if (sm.table.settings.current <= sm.table.settings.pages) {
				html +=
					'				<li class="paginate_button active" aria-controls="' +
					tableId +
					'" tabindex="0"><a href="javascript:void(0)">' +
					sm.table.settings.current +
					"</a></li>";
			}

			for (var i = sm.table.settings.current + 1; i <= sm.table.settings.current + sm.table.settings.offsetSize; i++) {
				if (i <= sm.table.settings.pages) {
					html +=
						'				<li class="paginate_button paginate_number_button" aria-controls="' +
						tableId +
						'" tabindex="0"><a href="javascript:void(0)">' +
						i +
						"</a></li>";
				}
			}

			html +=
				'				<li id="' +
				tableId +
				'_next" class="paginate_button next ' +
				(sm.table.settings.current < sm.table.settings.pages ? "" : "disabled") +
				'" aria-controls="' +
				tableId +
				'" tabindex="0"><a href="javascript:void(0)">Next</a></li>';
			html +=
				'				<li id="' +
				tableId +
				'_last" class="paginate_button last ' +
				(sm.table.settings.current < sm.table.settings.pages ? "" : "disabled") +
				'" aria-controls="' +
				tableId +
				'" tabindex="0"><a href="javascript:void(0)">Last</a></li>';
			html += "			</ul>";
			html += "		</div>";
			html += "	</div>";
			html += "</div>";
			sm.table.settings.obj.after(html);

			// Register pagination event listeners
			sm.table.paginationHandler();
		},

		clear: function () {
			if (sm.table.options.tools.length > 0) sm.table.settings.obj.prev().remove();
			sm.table.settings.obj.html("");
			if (!sm.table.options.pagination.hide) sm.table.settings.obj.next().remove();
		},

		reload: function () {
			sm.table.clear();
			sm.table.load();
		},

		load: function () {
			if (sm.table.options.tools.length > 0) sm.table.createTools();
			sm.table.createHeader();
			if (sm.table.ajaxData()) sm.table.createBody();
			if (!sm.table.options.pagination.hide) sm.table.createPagination();
			if (sm.table.options.after) sm.table.options.after();
		},

		search: function (d) {
			sm.table.settings.current = 1;
			if (d) sm.table.options.data = d;
			sm.table.reload();
		},

		generate: function (c) {
			sm.table.options = $.extend({}, sm.table.options, c);
			if (sm.table.options.columns.length > 0 && sm.table.options.url) sm.table.load();
			return sm.table;
		},

		getSelectedItems: function () {
			var array = [];
			sm.table.settings.obj.find("tbody > tr > td input[type=checkbox]:checked").each(function () {
				array.push($(this));
			});
			return $(array);
		},

		getSelectedItemKeys: function (key) {
			var temp = "";
			sm.table.getSelectedItems().each(function (i, d) {
				if (i > 0) temp += ",";
				temp += sm.table.settings.records[this.attr("index")][key];
			});
			return temp;
		},

		validateSelected: function (selectOne) {
			var bool = true;
			if (sm.table.getSelectedItems().length < 1) {
				$.gritter.add({ text: "Please select at least one row" });
				bool = false;
			} else if (selectOne && sm.table.getSelectedItems().length != 1) {
				$.gritter.add({ text: "Only one row can be operated on" });
				bool = false;
			}
			return bool;
		},

		ajaxRequest: function (d) {
			$.ajax({
				type: d.type,
				url: d.url,
				data: $.extend({}, { ids: sm.table.getSelectedItemKeys("id") }, d.data),
				async: d.async,
				cache: false,
				dataType: d.dataType,
				success: function (data) {
					if (d.success) d.success(data);
				},
				error: function () {
					d.error();
				},
				complete: function () {
					d.after();
				},
			});
		},

		ajax: function (d) {
			var def = {
				selectOne: false,
				type: "post",
				url: "",
				data: {},
				async: true,
				dataType: "json",
				confirm: null,
				success: function (data) {
					if (data && data.message) $.gritter.add({ text: data.message });
					else $.gritter.add({ text: "Operation successful!" });
				},
				error: function (data) {
					if (data && data.message) $.gritter.add({ text: data.message });
					else $.gritter.add({ text: "Operation failed!" });
				},
				after: function () {
					sm.table.reload();
				},
			};

			d = $.extend({}, def, d);

			if (sm.table.validateSelected(d.selectOne)) {
				if (d.confirm != null) {
					bootbox.confirm(d.confirm, function (result) {
						if (result) sm.table.ajaxRequest(d);
					});
				} else {
					sm.table.ajaxRequest(d);
				}
			}
		},

		ajaxDelete: function (d) {
			sm.table.ajax(
				$.extend(
					{},
					{
						confirm: "Confirm?",
						success: function (data) {
							if (data && data.message) $.gritter.add({ text: data.message });
							else $.gritter.add({ text: "Deleted successfully!" });
						},
						error: function (data) {
							if (data && data.message) $.gritter.add({ text: data.message });
							else $.gritter.add({ text: "Delete failed!" });
						},
					},
					d
				)
			);
		},

		ajaxEnable: function (d, enable) {
			sm.table.ajax($.extend({}, { data: { isEnable: enable } }, d));
		},
	};
})(smart, jQuery);

jQuery(function ($) {
	$.table = function (c) {
		return smart.table.generate(c);
	};

	$.fn.table = function (c) {
		smart.table.settings.obj = $(this);
		return $.table(c);
	};
});
